<!DOCTYPE html>
<html>
  <head>
    <title>Projects</title>
    <link rel='stylesheet' href='/stylesheets/style.css' />
  </head>
  <body>
    <%- include('navbar') %>

    <h1 id="title">Projects to Crowdfund</h1>
    <a id="proposeLink">Propose a project</a>

    <h2>List of Projects</h2>
    <!-- TODO: Filtering Form, defaults to open projects, default school if logged in -->
    <form id="filterForm">
      <label for="filter">Search:</label>
      <input type="text" id="searchQuery" name="searchQuery" />
      <button type="submit">Filter</button>
      <br>
      <label for="status">Status:</label>
      <select name="status" id="status">
        <option value="open">Open</option>
        <option value="closed">Closed</option>
        <option value="proposed">Proposed</option>
        <option value="any">Any</option>
      </select>
      
      <label for="schools" id="schoolslabel">From schools:</label>
      <select name="schools" id="schools">
        <option value="any">Any</option>
      </select>
    </form>

    <ol id="projectList">

    </ol>
  </body>
  <script>
    const queryString = window.location.search;
    console.log(queryString)
    const urlParams = new URLSearchParams(queryString);
    var school = "any";
    var schoolslabel = document.getElementById("schoolslabel");
    var schools = document.getElementById("schools");
    if (urlParams.has('school')) {
      school = urlParams.get('school');
      var title = document.getElementById("title");
      title.innerHTML += " - " + school;
      schoolslabel.hidden = "hidden";
      schools.hidden = "hidden"
    } else {
      if (localStorage.getItem('firebtoken')) {
        //Get user's favourite schools
        //Add them to the dropdown box
        //Could also add an 'all favourites' option
      } else {
        schoolslabel.hidden = "hidden";
        schools.hidden = "hidden"
      }
    }

    var form = document.getElementById("filterForm");
    var projectList = document.getElementById("projectList");

    async function sendFilter(event) {
      event.preventDefault();
      var searchQuery = document.getElementById("searchQuery").value;
      if (school == "any") {
        school = schools.value
      }
      var status = document.getElementById("status").value;
      // Post-Request to Filter Projects
      var response = await fetch("/projects", {
        method: "POST",
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          searchQuery: searchQuery,
          school: school,
          status: status
        })
      });

      var json = await response.json();
      console.log(json);

      if (response.status == 200) {
        console.log("Success Filter");
        projectList.innerHTML = ""; // Clear existing project list

        // TODO: More advanced project list such as school, status, etc.
        json.projects.forEach(function(project) {
          var li = document.createElement("li");
          var link = document.createElement("a");
          link.href = "/projects/view/" + project.projectid;
          link.text = project.title;
          li.appendChild(link);
          projectList.appendChild(li);
        });
      } else {
        alert("Tried but failed to get projects");
      }
    }

    form.addEventListener('submit', sendFilter);

    // Initial Load
    sendFilter(new Event('submit'));

    var proposeLink = document.getElementById('proposeLink');
    if (localStorage.getItem('firebtoken')) {
      proposeLink.href = '/projects/create/?firebtoken=' + localStorage.getItem('firebtoken');
    } else {
      proposeLink.style = 'display: none;';
    }
  </script>
  
</html>
