<!DOCTYPE html>
<html>
  <head>
    <title>User Settings</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="/stylesheets/style.css">
  </head>
  <body>
    <%- include('navbar') %>
    <h1>Settings Page</h1>
    <p>UID: <%= locals.user.uid || ''%></p>
    <form id="SettingsForm">
        <label for="email">Email</label><br>
        <input disabled type="text" id="emailField" name="emailField" value="<%= locals.user.email || '' %>"><br>
    </form>

    <h2> Change Password </h2>
    <form id="changePassForm">
        <label for="password">New Password</label><br>
        <input type="password" id="passField" name="passField"><br>
        <label for="password">Confirm New Password</label><br>
        <input type="password" id="confirmPassField" name="confirmPassField">
        <button type="submit">Submit</button>
    </form>


    <h2> Delete Account </h2>
    <!-- Probably better done as a modal in the future -->
    <form id="deleteAccountForm">
        <label for="email">Enter your email to confirm deletion</label><br>
        <input type="text" id="confirmEmailField" name="confirmEmailField"><br>
        <button type="submit">Delete Account</button>
    </form>
</body>
  <script>
    var form = document.getElementById("changePassForm");
    async function sendChangePass(event){
        event.preventDefault();
        var pass = document.getElementById("passField").value;

        if (pass != document.getElementById("confirmPassField").value){
            alert("Passwords do not match")
            return
        }

        if (pass.length < 6){
            alert("Password must be at least 6 characters long")
            return
        }

        // Post-Request to /auth/resetpassword
        var response = await fetch("/auth/resetpassword", {
            method: "POST",
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                password: pass
            })
        })

        var json = await response.json()
        console.log(json)
        if (response.status == 200){
            console.log("Success Change Password")
            alert("Password Changed Successfully, you will need to sign in again with your new password.")
            window.location.href = "/login"
        }
        else{
            alert("Tried but failed to change password")
        }
    }
    form.addEventListener('submit', sendChangePass);

    var deleteAccountForm = document.getElementById("deleteAccountForm");
    async function sendDeleteAccount(event){
        event.preventDefault();
        var email = document.getElementById("confirmEmailField").value;
        var originalEmail = "<%= locals.user.email || '' %>"
        if (email != originalEmail){
            alert("Email does not match")
            return
        }

        // Post Request to /auth/deleteaccount
        var response = await fetch("/auth/deleteaccount", {
            method: "POST",
            headers: {
                'Content-Type': 'application/json'
            },
        })

        var json = await response.json()
        console.log(json)
        if (response.status == 200){
            console.log("Success Delete Account")
            alert("Account Deleted Successfully")
            window.location.href = "/"
        }
        else{
            alert(response.body);
        }
    }
    deleteAccountForm.addEventListener('submit', sendDeleteAccount);
  </script>
</html>
